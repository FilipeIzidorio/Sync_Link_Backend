-- Tabela de usuários
CREATE TABLE IF NOT EXISTS usuarios (
    id BIGSERIAL PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    senha VARCHAR(255) NOT NULL,
    perfil VARCHAR(20) NOT NULL,
    ativo BOOLEAN DEFAULT TRUE,
    data_criacao TIMESTAMP NOT NULL,
    data_atualizacao TIMESTAMP
);

-- Tabela de mesas (sem capacidade)
CREATE TABLE IF NOT EXISTS mesas (
    id BIGSERIAL PRIMARY KEY,
    numero INTEGER UNIQUE NOT NULL,
    status VARCHAR(20) NOT NULL,
    descricao VARCHAR(255)
);

-- Tabela de categorias
CREATE TABLE IF NOT EXISTS categorias (
    id BIGSERIAL PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    descricao VARCHAR(255),
    ativo BOOLEAN DEFAULT TRUE
);

-- Tabela de produtos (sem tempo_preparo)
CREATE TABLE IF NOT EXISTS produtos (
    id BIGSERIAL PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    descricao VARCHAR(500),
    preco NUMERIC(10,2) NOT NULL,
    ativo BOOLEAN DEFAULT TRUE,
    categoria_id BIGINT NOT NULL,
    data_criacao TIMESTAMP NOT NULL,
    data_atualizacao TIMESTAMP,
    FOREIGN KEY (categoria_id) REFERENCES categorias(id)
);

-- Tabela de pedidos (atualizada com campos de acréscimo/desconto)
CREATE TABLE IF NOT EXISTS pedidos (
    id BIGSERIAL PRIMARY KEY,
    mesa_id BIGINT NOT NULL,
    usuario_id BIGINT NOT NULL,
    status VARCHAR(20) NOT NULL,
    subtotal NUMERIC(10,2) DEFAULT 0,
    acrescimo NUMERIC(10,2) DEFAULT 0,
    desconto NUMERIC(10,2) DEFAULT 0,
    total NUMERIC(10,2) DEFAULT 0,
    valor_final NUMERIC(10,2) DEFAULT 0,
    observacao TEXT,
    justificativa_acrescimo TEXT,
    justificativa_desconto TEXT,
    data_criacao TIMESTAMP NOT NULL,
    data_atualizacao TIMESTAMP,
    data_fechamento TIMESTAMP,
    FOREIGN KEY (mesa_id) REFERENCES mesas(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- Tabela de itens do pedido (sem status)
CREATE TABLE IF NOT EXISTS itens_pedido (
    id BIGSERIAL PRIMARY KEY,
    pedido_id BIGINT NOT NULL,
    produto_id BIGINT NOT NULL,
    quantidade INTEGER NOT NULL,
    preco_unitario NUMERIC(10,2) NOT NULL,
    observacao TEXT,
    FOREIGN KEY (pedido_id) REFERENCES pedidos(id),
    FOREIGN KEY (produto_id) REFERENCES produtos(id)
);

-- Tabela de estoque
CREATE TABLE IF NOT EXISTS estoque (
    id BIGSERIAL PRIMARY KEY,
    produto_id BIGINT NOT NULL,
    quantidade INTEGER NOT NULL,
    estoque_minimo INTEGER NOT NULL,
    estoque_maximo INTEGER,
    custo_unitario NUMERIC(10,2),
    data_entrada TIMESTAMP NOT NULL,
    data_validade TIMESTAMP,
    lote VARCHAR(100),
    FOREIGN KEY (produto_id) REFERENCES produtos(id)
);

-- Índices para melhor performance
CREATE INDEX IF NOT EXISTS idx_pedidos_status ON pedidos(status);
CREATE INDEX IF NOT EXISTS idx_pedidos_mesa_id ON pedidos(mesa_id);
CREATE INDEX IF NOT EXISTS idx_pedidos_data_criacao ON pedidos(data_criacao);
CREATE INDEX IF NOT EXISTS idx_mesas_status ON mesas(status);
CREATE INDEX IF NOT EXISTS idx_itens_pedido_pedido_id ON itens_pedido(pedido_id);


-- Inserir usuário administrador padrão (senha: 123456)
INSERT INTO usuarios (nome, email, senha, perfil, ativo, data_criacao)
VALUES ('Administrador', 'admin@synclink.com', '$2a$10$ABCDEFGHIJKLMNOPQRSTUVWXYZ012345', 'ADMIN', true, NOW());

-- Inserir categorias padrão
INSERT INTO categorias (nome, descricao, ativo) VALUES
('Bebidas', 'Refrigerantes, sucos, água e outras bebidas', true),
('Pratos Principais', 'Pratos principais do cardápio', true),
('Sobremesas', 'Doces e sobremesas variadas', true),
('Aperitivos', 'Entradas e petiscos', true);

-- Inserir mesas padrão (sem capacidade)
INSERT INTO mesas (numero, status, descricao) VALUES
(1, 'LIVRE', 'Mesa próxima à janela'),
(2, 'LIVRE', 'Mesa central'),
(3, 'LIVRE', 'Mesa grande para grupos'),
(4, 'LIVRE', 'Mesa para casal'),
(5, 'LIVRE', 'Mesa no fundo');